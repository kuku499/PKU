---
title: "R Notebook"
output: html_notebook
---

### repeated-mesure ANOVA: one-way

所有员工四个季度的工资是否有差异？

```{r}
# one-way within-group design
# dependent variable：sal1/sal2/sal3/sal4
# with-group variables：time

rm(list = ls()) # clear all the variables in global environment

library(rstatix) # identify_outliers, and include good stats test functions
library(dplyr) # %>%
library(bruceR) # a good ANOVA related wrapper
library(afex)
library(ggpubr)  # plot in publication-ready formats
library(purrr)  # for functions dealing with functions

wide_data = data.frame(s1 = c(3,3,4,6,6,8), s2 = c(5,3,5,7,8,8), s3=c(8,5,8,9,8,10), s4 =c(8,9,7,10,10,10))

long_data = data.frame(score = c(3,3,4,6,6,8,5,3,5,7,8,8,8,5,8,9,8,10,8,9,7,10,10,10),subj = rep(1:6,times=4),strategy=c(rep(1,6),rep(2,6),rep(3,6),rep(4,6)))
long_data$strategy = as.factor(long_data$strategy)
#repeat_data <- read_sav("data.sav")
#repeat_data <- data.frame(repeat_data) ###CAUTION###

# check missing values
sum(is.na(wide_data$s1))
sum(is.na(wide_data$s2))
sum(is.na(wide_data$s3))
sum(is.na(wide_data$s4))

sum(is.na(long_data$score))

# check outliers, using boxplot 1.5*IQR
identify_outliers(wide_data,s1)
identify_outliers(wide_data,s2)
identify_outliers(wide_data,s3)
identify_outliers(wide_data,s4)

# check normality
shapiro_test(wide_data$s1)
shapiro_test(wide_data$s2)
shapiro_test(wide_data$s3)
shapiro_test(wide_data$s4)
wide_data %>% map(shapiro_test)  # apply shapiro function for each element in the data frame
long_data %>%
  group_by(strategy) %>%
  shapiro_test(score)

# check equal variance assumption? No need, since there is no multiple groups of subjects.
# here is just for demonstration purpose.
wide_data %>% map(var)  # compute var() for each element in the data frame
library(car)
leveneTest(score~strategy,data=long_data)

#check sphericity by using Mauchly test （the bruceR MANOVA will do it automatically for you)
matrix_data = matrix(long_data$score,nrow=6,ncol=4)  # organize the data as a matrix
mlmfit = lm(matrix_data ~ 1)  
mauchly.test(mlmfit,X=~1)

# actual ANOVA computation
# using bruceR package
repeat_fit <- MANOVA(long_data,
                     subID = "subj", 
                     dv = "score", 
                     within = "strategy", 
                     sph.correction = "GG")  # greenhouse-geisser correction 
EMMEANS(repeat_fit, effect = "strategy")  #EMMEANS is for comparing means, either for simple effect (later) or for multiple comparisons. For multiple comparison, its default correction is bonferrroni correction.
EMMEANS(repeat_fit, effect = "strategy",p.adjust="tukey") 

# manual computation of Tukey HSD
Q_HSD = qtukey(0.95,ncol(wide_data),nrow(wide_data))
HSD = Q_HSD*sqrt(repeat_fit$anova_table$MSE/nrow(wide_data))
```